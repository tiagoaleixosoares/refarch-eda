<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Command Query Responsibility Segregation (CQRS) pattern"><meta name=author content="Jerome Boyer"><link href=https://ibm-cloud-architecture.github.com/refarch-eda/patterns/cqrs/ rel=canonical><link href=../event-sourcing/ rel=prev><link href=../saga/ rel=next><link rel=icon href=../../assets/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.17"><title>Patterns in Event-Driven Architectures - IBM Automation - Event-driven Solution - Sharing knowledge</title><link rel=stylesheet href=../../assets/stylesheets/main.bcfcd587.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#command-query-responsibility-segregation-cqrs class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="IBM Automation - Event-driven Solution - Sharing knowledge" class="md-header__button md-logo" aria-label="IBM Automation - Event-driven Solution - Sharing knowledge" data-md-component=logo> <img src=../../images/es-icon.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> IBM Automation - Event-driven Solution - Sharing knowledge </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Patterns in Event-Driven Architectures </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ibm-cloud-architecture/refarch-eda title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> ibm-cloud-architecture/refarch-eda </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="IBM Automation - Event-driven Solution - Sharing knowledge" class="md-nav__button md-logo" aria-label="IBM Automation - Event-driven Solution - Sharing knowledge" data-md-component=logo> <img src=../../images/es-icon.png alt=logo> </a> IBM Automation - Event-driven Solution - Sharing knowledge </label> <div class=md-nav__source> <a href=https://github.com/ibm-cloud-architecture/refarch-eda title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> ibm-cloud-architecture/refarch-eda </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../news/ class=md-nav__link> <span class=md-ellipsis> What's new </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Introduction </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Introduction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../introduction/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../introduction/reference-architecture/ class=md-nav__link> <span class=md-ellipsis> Reference Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../introduction/usecases/ class=md-nav__link> <span class=md-ellipsis> Business Use Cases </span> </a> </li> <li class=md-nav__item> <a href=../../introduction/target-audiences/ class=md-nav__link> <span class=md-ellipsis> Target Audiences </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Learning Journey </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Learning Journey </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../journey/101/ class=md-nav__link> <span class=md-ellipsis> Get started (101 content) </span> </a> </li> <li class=md-nav__item> <a href=../../journey/201/ class=md-nav__link> <span class=md-ellipsis> Deeper dive (201 content) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../concepts/terms-and-definitions/ class=md-nav__link> <span class=md-ellipsis> Terms & Definitions </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/integration/ class=md-nav__link> <span class=md-ellipsis> Agile Integration </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/events-versus-messages/ class=md-nav__link> <span class=md-ellipsis> Event streaming versus Queuing </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/fit-to-purpose/ class=md-nav__link> <span class=md-ellipsis> Fit for purpose </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/model/ class=md-nav__link> <span class=md-ellipsis> Devising the data models </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/flow-architectures/ class=md-nav__link> <span class=md-ellipsis> Flow Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/service-mesh/ class=md-nav__link> <span class=md-ellipsis> Service mesh </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Advantages of EDA </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Advantages of EDA </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../advantages/microservice/ class=md-nav__link> <span class=md-ellipsis> Microservice decoupling </span> </a> </li> <li class=md-nav__item> <a href=../../advantages/reactive/ class=md-nav__link> <span class=md-ellipsis> Reactive systems </span> </a> </li> <li class=md-nav__item> <a href=../../advantages/resiliency/ class=md-nav__link> <span class=md-ellipsis> Resiliency </span> </a> </li> <li class=md-nav__item> <a href=../../advantages/scalability/ class=md-nav__link> <span class=md-ellipsis> Scalability </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7 checked> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Patterns in EDA </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=true> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Patterns in EDA </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../intro/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../event-sourcing/ class=md-nav__link> <span class=md-ellipsis> Event Sourcing </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> CQRS </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> CQRS </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#problems-and-constraints class=md-nav__link> <span class=md-ellipsis> Problems and Constraints </span> </a> </li> <li class=md-nav__item> <a href=#solution-and-pattern class=md-nav__link> <span class=md-ellipsis> Solution and Pattern </span> </a> <nav class=md-nav aria-label="Solution and Pattern"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#typical-application-data-access class=md-nav__link> <span class=md-ellipsis> Typical application data access </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-apis class=md-nav__link> <span class=md-ellipsis> Separate read and write APIs </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-models class=md-nav__link> <span class=md-ellipsis> Separate read and write models </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-databases class=md-nav__link> <span class=md-ellipsis> Separate read and write databases </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#considerations class=md-nav__link> <span class=md-ellipsis> Considerations </span> </a> </li> <li class=md-nav__item> <a href=#combining-event-sourcing-and-cqrs class=md-nav__link> <span class=md-ellipsis> Combining event sourcing and CQRS </span> </a> </li> <li class=md-nav__item> <a href=#keeping-the-write-model-on-mainframe class=md-nav__link> <span class=md-ellipsis> Keeping the write model on Mainframe </span> </a> </li> <li class=md-nav__item> <a href=#the-consistency-challenges class=md-nav__link> <span class=md-ellipsis> The consistency challenges </span> </a> <nav class=md-nav aria-label="The consistency challenges"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cqrs-and-change-data-capture class=md-nav__link> <span class=md-ellipsis> CQRS and Change Data Capture </span> </a> </li> <li class=md-nav__item> <a href=#delay-in-the-view class=md-nav__link> <span class=md-ellipsis> Delay in the view </span> </a> </li> <li class=md-nav__item> <a href=#schema-change class=md-nav__link> <span class=md-ellipsis> Schema change </span> </a> </li> <li class=md-nav__item> <a href=#code-reference class=md-nav__link> <span class=md-ellipsis> Code reference </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../saga/ class=md-nav__link> <span class=md-ellipsis> Saga </span> </a> </li> <li class=md-nav__item> <a href=../dlq/ class=md-nav__link> <span class=md-ellipsis> Dead Letter Queue </span> </a> </li> <li class=md-nav__item> <a href=../topic-replication/ class=md-nav__link> <span class=md-ellipsis> Topic Replication </span> </a> </li> <li class=md-nav__item> <a href=../data-pipeline/ class=md-nav__link> <span class=md-ellipsis> Data Intensive App </span> </a> </li> <li class=md-nav__item> <a href=../realtime-analytics/ class=md-nav__link> <span class=md-ellipsis> Near real-time analytics </span> </a> </li> <li class=md-nav__item> <a href=../api-mgt/ class=md-nav__link> <span class=md-ellipsis> API management </span> </a> </li> <li class=md-nav__item> <a href=../cep/ class=md-nav__link> <span class=md-ellipsis> Situational decision </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> Methodology </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Methodology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../methodology/event-storming/ class=md-nav__link> <span class=md-ellipsis> Event Storming </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/domain-driven-design/ class=md-nav__link> <span class=md-ellipsis> Domain-Driven Design </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/data-intensive/ class=md-nav__link> <span class=md-ellipsis> Data Intensive App Development </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/data-lineage/ class=md-nav__link> <span class=md-ellipsis> Data lineage </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/governance/ class=md-nav__link> <span class=md-ellipsis> Governance </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9 id=__nav_9_label tabindex=0> <span class=md-ellipsis> Technology </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> Technology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../technology/kafka-overview/ class=md-nav__link> <span class=md-ellipsis> Kafka Overview </span> </a> </li> <li class=md-nav__item> <a href=../../technology/event-streams/ class=md-nav__link> <span class=md-ellipsis> Event Streams </span> </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/eda-tech-academy/demo/ class=md-nav__link> <span class=md-ellipsis> Event Streams Demo Script </span> </a> </li> <li class=md-nav__item> <a href=../../technology/faq/ class=md-nav__link> <span class=md-ellipsis> Kafka FAQ </span> </a> </li> <li class=md-nav__item> <a href=../../technology/mq/ class=md-nav__link> <span class=md-ellipsis> MQ in EDA context </span> </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-producers/ class=md-nav__link> <span class=md-ellipsis> Kafka Producers </span> </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-consumers/ class=md-nav__link> <span class=md-ellipsis> Kafka Consumers </span> </a> </li> <li class=md-nav__item> <a href=../../technology/avro-schemas/ class=md-nav__link> <span class=md-ellipsis> Avro Schema </span> </a> </li> <li class=md-nav__item> <a href=../../technology/advanced-kafka/ class=md-nav__link> <span class=md-ellipsis> Advanced Concepts </span> </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-streams/ class=md-nav__link> <span class=md-ellipsis> Kafka Streams </span> </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-connect/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect </span> </a> </li> <li class=md-nav__item> <a href=../../technology/event-streams/es-maas/security/ class=md-nav__link> <span class=md-ellipsis> Kafka security </span> </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-monitoring/ class=md-nav__link> <span class=md-ellipsis> Kafka Monitoring </span> </a> </li> <li class=md-nav__item> <a href=../../technology/kafka-mirrormaker/ class=md-nav__link> <span class=md-ellipsis> Mirror Maker 2 </span> </a> </li> <li class=md-nav__item> <a href=../../technology/security/ class=md-nav__link> <span class=md-ellipsis> Security </span> </a> </li> <li class=md-nav__item> <a href=../../technology/flink/ class=md-nav__link> <span class=md-ellipsis> Apache Flink </span> </a> </li> <li class=md-nav__item> <a href=../../technology/spring/ class=md-nav__link> <span class=md-ellipsis> Spring cloud </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10> <label class=md-nav__link for=__nav_10 id=__nav_10_label tabindex=0> <span class=md-ellipsis> Use Cases </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_10_label aria-expanded=false> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> Use Cases </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../use-cases/gitops/ class=md-nav__link> <span class=md-ellipsis> Event-driven solution GitOps </span> </a> </li> <li class=md-nav__item> <a href=../../technology/event-streams/es-cp4i/ class=md-nav__link> <span class=md-ellipsis> Deploy Event-Streams </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/connect-s3/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect - S3 </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/connect-cos/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect - COS </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/connect-jdbc/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect - jdbc </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/connect-mq/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect - MQ </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/connect-rabbitmq/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect - Rabbitmq </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/kafka-streams/ class=md-nav__link> <span class=md-ellipsis> Kafka Streams labs </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/db2-debezium/ class=md-nav__link> <span class=md-ellipsis> DB2 - CDC Debezium - Outbox </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/kafka-mm2/ class=md-nav__link> <span class=md-ellipsis> Mirror maker 2 labs </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/schema-registry-on-cloud/ class=md-nav__link> <span class=md-ellipsis> Schema registry ES on Cloud </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/schema-registry-on-ocp/ class=md-nav__link> <span class=md-ellipsis> Schema registry </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/monitoring-on-cloud/ class=md-nav__link> <span class=md-ellipsis> Monitoring ES on Cloud </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/monitoring-on-ocp/ class=md-nav__link> <span class=md-ellipsis> Monitoring ES </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_11> <label class=md-nav__link for=__nav_11 id=__nav_11_label tabindex=0> <span class=md-ellipsis> Scenarios </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_11_label aria-expanded=false> <label class=md-nav__title for=__nav_11> <span class="md-nav__icon md-icon"></span> Scenarios </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../scenarios/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/refarch-kc/ class=md-nav__link> <span class=md-ellipsis> Reefer Shipment Solution </span> </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/vaccine-solution-main/ class=md-nav__link> <span class=md-ellipsis> Vaccine at Scale </span> </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/eda-rt-inventory-gitops class=md-nav__link> <span class=md-ellipsis> Near real-time Inventory </span> </a> </li> <li class=md-nav__item> <a href=../../scenarios/saga-orchestration/ class=md-nav__link> <span class=md-ellipsis> SAGA with MQ Orchestration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../additional-reading/ class=md-nav__link> <span class=md-ellipsis> Additional reading </span> </a> </li> <li class=md-nav__item> <a href=../../contribute/ class=md-nav__link> <span class=md-ellipsis> Contribute to this Site </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#problems-and-constraints class=md-nav__link> <span class=md-ellipsis> Problems and Constraints </span> </a> </li> <li class=md-nav__item> <a href=#solution-and-pattern class=md-nav__link> <span class=md-ellipsis> Solution and Pattern </span> </a> <nav class=md-nav aria-label="Solution and Pattern"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#typical-application-data-access class=md-nav__link> <span class=md-ellipsis> Typical application data access </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-apis class=md-nav__link> <span class=md-ellipsis> Separate read and write APIs </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-models class=md-nav__link> <span class=md-ellipsis> Separate read and write models </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-databases class=md-nav__link> <span class=md-ellipsis> Separate read and write databases </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#considerations class=md-nav__link> <span class=md-ellipsis> Considerations </span> </a> </li> <li class=md-nav__item> <a href=#combining-event-sourcing-and-cqrs class=md-nav__link> <span class=md-ellipsis> Combining event sourcing and CQRS </span> </a> </li> <li class=md-nav__item> <a href=#keeping-the-write-model-on-mainframe class=md-nav__link> <span class=md-ellipsis> Keeping the write model on Mainframe </span> </a> </li> <li class=md-nav__item> <a href=#the-consistency-challenges class=md-nav__link> <span class=md-ellipsis> The consistency challenges </span> </a> <nav class=md-nav aria-label="The consistency challenges"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cqrs-and-change-data-capture class=md-nav__link> <span class=md-ellipsis> CQRS and Change Data Capture </span> </a> </li> <li class=md-nav__item> <a href=#delay-in-the-view class=md-nav__link> <span class=md-ellipsis> Delay in the view </span> </a> </li> <li class=md-nav__item> <a href=#schema-change class=md-nav__link> <span class=md-ellipsis> Schema change </span> </a> </li> <li class=md-nav__item> <a href=#code-reference class=md-nav__link> <span class=md-ellipsis> Code reference </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=command-query-responsibility-segregation-cqrs>Command-Query Responsibility Segregation (CQRS)<a class=headerlink href=#command-query-responsibility-segregation-cqrs title="Permanent link">&para;</a></h1> <h2 id=problems-and-constraints>Problems and Constraints<a class=headerlink href=#problems-and-constraints title="Permanent link">&para;</a></h2> <p>A domain model encapsulates domain data with the behavior for maintaining the correctness of that data as it is modified, structuring the data based on how it is stored in the database and to facilitate managing the data. Multiple clients can independently update the data concurrently. Different clients may not use the data the way the domain model structures it, and may not agree with each other on how it should be structured.</p> <p><strong>When a domain model becomes overburdened managing complex aggregate objects, concurrent updates, and numerous cross-cutting views, how can it be refactored to separate different aspects of how the data is used?</strong></p> <p>An application accesses data both to read and to modify it. The primitive data tasks are often expressed as create, read, update, and delete (CRUD); using them is known as CRUDing the data. Application code often does not make much distinction between the tasks; individual operations may mix reading the data with changing the data as needed.</p> <p>This simple approach works well when all clients of the data can use the same structure and contention is low. A single domain model can manage the data, make it accessible as domain objects, and ensure updates maintain its consistency. However, this approach becomes inadaquate when different clients want different views across multiple sets of data, when the data is too widely used, and/or when multiple clients updating the data my unknowlingly conflict with each other.</p> <p>For example, in a microservices architecture, each microservice should store and manage its own data, but a user interface may need to display data from several microservices. A query that gathers bits of data from multiple sources can be inefficient (time and bandwidth consumed accessing multiple data sources, CPU consumed transforming data, memory consumed by intermediate objects) and must be repeated each time the data is accessed.</p> <p>Another example is an enterprise database of record managing data required by multiple applications. It can become overloaded with too many clients needing too many connections to run too many threads performing too many transactions--such that the database becomes a performance bottleneck and can even crash.</p> <p>Another example is maintaining consistency of the data while clients concurrently make independent updates to the data. While each update may be consistent, they may conflict with each other. Database locking ensures that the updates don't change the same data concurrently, but doesn't ensure multiple independent changes result in a consistent data model.</p> <p>When data usage is more complex than a single domain model can facilitate, a more sophisticated approach is needed.</p> <h2 id=solution-and-pattern>Solution and Pattern<a class=headerlink href=#solution-and-pattern title="Permanent link">&para;</a></h2> <p><strong>Refactor a domain model to separate operations for querying data and operations for updating data so that they may be handled independently.</strong></p> <p>The CQRS pattern strictly segregates operations that read data from operations that update data. An operation can read data (the R in CRUD) or can write data (the CUD in CRUD), but not both.</p> <p>This separation can make using data much more manageable in several respects. The read operations and the write operations are simpler to implement because their functionality is more finely focused. The operations can be developed independently, potentially by separate teams. The operations can be optimized independently and can evolve independently, following changing user requirements more easily. These optimized operations can scale better, perform better, and security can be applied more precisely.</p> <p>The full CQRS pattern uses separate read and write databases. In doing so, the pattern segregates not just the APIs for accessing data or the models for managing data, but even segregates the database itself into two, a read/write database that is effectively write-only and one or more read-only databases.</p> <p>The adoption of the pattern can be applied in phases, incrementally from existing code. To illustrate this, we will use four stages that could be used incrementally or a developer can go directly from stage 0 to 3 without considering the others:</p> <ol> <li>Stage 0: <a href=#typical-application-data-access>Typical application data access</a></li> <li>Stage 1: <a href=#separate-read-and-write-apis>Separate read and write APIs</a></li> <li>Stage 2: <a href=#separate-read-and-write-models>Separate read and write models</a></li> <li>Stage 3: <a href=#separate-read-and-write-databases>Separate read and write databases</a></li> </ol> <h3 id=typical-application-data-access>Typical application data access<a class=headerlink href=#typical-application-data-access title="Permanent link">&para;</a></h3> <p>Before even beginning to apply the pattern, let’s consider the typical app design for accessing data. This diagram shows an app with a domain model for accessing data persisted in a database of record, i.e. a single source of truth for that data. The domain model has an API that at a minimum enables clients to perform CRUD tasks on domain objects within the model.</p> <p><img alt=1 src=images/fig-1.png></p> <p>The <a href=https://www.martinfowler.com/eaaCatalog/domainModel.html>domain model</a> is an object representation of the database documents or records. It is comprised of domain objects that represent individual documents or records and the business logic for managing and using them. <a href=https://dddcommunity.org/learning-ddd/what_is_ddd/ >Domain-Driven Design</a> (DDD) models these domain objects as <a href=https://martinfowler.com/bliki/EvansClassification.html>entities</a>—“objects that have a distinct identity that runs through time and different representations”—and <a href=https://martinfowler.com/bliki/DDD_Aggregate.html>aggregates</a>—“a cluster of domain objects that can be treated as a single unit”; the aggregate root maintains the integrity of the aggregate as a whole.</p> <p>Ideally, the domain model’s API should be more domain-specific than simply CRUDing of data. Instead, it should expose higher-level operations that represent business functionality like <code>findCustomer()</code>, <code>placeOrder()</code>, <code>transferFunds()</code>, and so on. These operations read and update data as needed, sometimes doing both in a single operation. They are correct as long as they fit the way the business works.</p> <h3 id=separate-read-and-write-apis>Separate read and write APIs<a class=headerlink href=#separate-read-and-write-apis title="Permanent link">&para;</a></h3> <p>The first and most visible step in applying the CQRS pattern is splitting the CRUD API into separate read and write APIs. This diagram shows the same domain model as before, but its single CRUD API is split into retrieve and modify APIs.</p> <p><img alt=2 src=images/fig-2.png></p> <p>The two APIs share the existing domain model but split the behavior:</p> <ul> <li><strong>Read</strong>: The retrieve API is used to read the existing state of the objects in the domain model without changing that state. The API treats the domain state as read only.</li> <li><strong>Write</strong>: The modify API is used to change the objects in the domain model. Changes are made using CUD tasks: create new domain objects, update the state in existing ones, and delete ones that are no longer needed. The operations in this API do not return result values, they return success (ack or void) or failure (nak or throw an exception). The create operation might return the primary of key of the entity, which can be generated either by the domain model or in the data source.</li> </ul> <p>This separation of APIs is an application of the <a href=https://martinfowler.com/bliki/CommandQuerySeparation.html>Command Query Separation</a> (CQS) pattern, which says to clearly separate methods that change state from those that don’t. To do so, each of an object’s methods can be in one of two categories (but not both):</p> <ul> <li><strong>Query</strong>: Returns a result. Does not change the system’s state nor cause any side effects that change the state.</li> <li><strong>Command</strong> (a.k.a. modifiers or mutators): Changes the state of a system. Does not return a value, just an indication of success or failure.</li> </ul> <p>With this approach, the domain model works the same and provides access to the data the same as before. What has changed is the API for using the domain model. Whereas a higher-level operation might previously have both changed the state of the application and returned a part of that state, now each such operation is redesigned to only do one or the other.</p> <p>When the domain model splits its API into read and write operations, clients using the API must likewise split their functionality into querying and updating functionality. Most new web based applications are based in the single page application, with components and services that use and encapsulate remote API. So this separation of backend API fits well with modern web applications.</p> <p>This stage depends on the domain model being able to implement both the retrieve and modify APIs. A single domain model requires the retrieve and modify behavior to have similar, corresponding implementations. For them to evolve independently, the two APIs will need to be implemented with separate read and write models.</p> <h3 id=separate-read-and-write-models>Separate read and write models<a class=headerlink href=#separate-read-and-write-models title="Permanent link">&para;</a></h3> <p>The second step in applying the CQRS pattern is to split the domain model into separate read and write models. This doesn’t just change the API for accessing domain functionality, it also changes the design of how that functionality is structured and implemented. This diagram shows that the domain model becomes the basis for a write model that handles changes to the domain objects, along with a separate read model used to access the state of the app.</p> <p><img alt=3 src=images/fig-3.png></p> <p>Naturally, the read model implements the retrieve API and the write model implements the modify API. Now, the application consists not only of separate APIs for querying and updating the domain objects, there’s also separate business functionality for doing so. Both the read business functionality and the write business functionality share the same database.</p> <p>The write model is implemented by specializing the domain model to focus solely on maintaining the valid structure of domain objects when changing their state and by applying any business rules.</p> <p>Meanwhile, responsibility for returning domain objects is shifted to a separate read model. The read model defines <a href=https://martinfowler.com/eaaCatalog/dataTransferObject.html>data transfer objects</a> (DTOs) designed specifically for the model to return just the data the client wants in a structure the client finds convenient. The read model knows how to gather the data used to populate the DTOs. DTOs encapsulate little if any domain functionality, they just bundle data into a convenient package that can easily be transmitted using a single method call, especially between processes.</p> <p>The read model should be able to implement the retrieve API by implementing the necessary queries and executing them. If the retrieve API is already built to return domain objects as results, the read model can continue to do so, or better yet, implements DTO types that are compatible with the domain objects and returns those. Likewise, the modify API was already implemented using the domain model, so the write model should preserve that. The write model may enhance the implementation to more explicitly implement a command interface or use command objects.</p> <p>This phase assumes that the read and write models can both be implemented using the same database of record the domain model has been using. To the extent this is true, the implementations of reading and writing can evolve independently and be optimized independently. This independence may become increasingly limited since they are both bound to the same database with a single schema or data model. To enable the read and write models to evolve independently, they may each need their own database.</p> <h3 id=separate-read-and-write-databases>Separate read and write databases<a class=headerlink href=#separate-read-and-write-databases title="Permanent link">&para;</a></h3> <p>The third step in applying the CQRS pattern—-which implements the complete CQRS pattern solution—-is splitting the database of record into separate read and write databases. This diagram shows the write model and read model, each supported by its own database. The overall solution consists of two main parts: the write solution that supports updating the data and the read solution that supports querying the data. The two parts are connected by the event bus.</p> <p><img alt=4 src=images/fig-4.png></p> <p>The write model has its own read/write database and the read model has its own read-only database. The read/write database still serves as the database of record (the single source of truth for the data) but is mostly used write-only: mostly written to and rarely read. Reading is offloaded onto a separate read database that contains the same data but is used read-only.</p> <p>The query database is effectively a cache of the database of record, with all of the inherit benefits and complexity of the Caching pattern. The query database contains a copy of the data in the database of record, with the copy structured and staged for easier access by the clients using the retrieve API. As a copy, overhead is needed to keep the copy synchronized with changes in the original. Latency in this synchronization process creates eventual consistency, during which the data copy is stale.</p> <p>The separate databases enable the separate read and write models and their respective retrieve and modify APIs to truly evolve independently. Not only can the read model or write model’s implementation change without changing the other, but how each stores its data can be changed independently.</p> <p>This solution offers the following advantages:</p> <ul> <li><strong>Scaling</strong>: The query load is moved from the write database to the read database. If the database of record is a scalability bottleneck and a lot of the load on it is caused by queries, unloading those query responsibilities can significantly improve the scalability of the combined data access.</li> <li><strong>Performance</strong>: The schemas of the two databases can be different, enabling them to be designed and optimized independently for better performance. The write database can be optimized for data consistency and correctness, with capabilities such as stored procedures that fit the write model and assist with data updates. The read database can store the data in units that better fit the read model and are better optimized for querying, with larger rows requiring fewer joins.</li> </ul> <p>Notice that the design for this stage is significantly more complex than the design for the previous stage. Separate databases with copies of the same data may make data modeling and using data easier, but they require significant overhead to synchronize the data and keep the copies consistent.</p> <p>CQRS employs a couple of design features that support keeping the databases synchronized:</p> <ul> <li><strong>Command Bus for queuing commands</strong> (optional): A more subtle and optional design decision is to queue the commands produced by the modify API, shown in the diagram as the command bus. This can significantly increase the throughput of multiple apps updating the database, as well as serialize updates to help avoid--or at least detect--merge conflicts. With the bus, a client making an update does not block synchronously while the change is written to the database. Rather, the request to change the database is captured as a <a href=https://en.wikipedia.org/wiki/Command_pattern>command</a> (<a href=https://www.pearson.com/us/higher-education/program/Gamma-Design-Patterns-Elements-of-Reusable-Object-Oriented-Software/PGM14333.html><em>Design Patterns</em></a>) and put on a message queue, after which the client can proceed with other work. Asynchronously in the background, the write model processes the commands at the maximum sustainable rate that the database can handle, without the database ever becoming overloaded. If the database becomes temporarily unavailable, the commands queue and will be processed when the database becomes available once more.</li> <li><strong>Event Bus for publishing update events</strong> (required): Whenever the write database is updated, a change notification is published as an event on the event bus. Interested parties can subscribe to the event bus to be notified when the database is updated. One such party is an event processor for the query database, which receives update events and processes them by updating the query database accordingly. In this way, every time the write database is updated, a corresponding update is made to the read database to keep it in sync.</li> </ul> <p>The connection between the command bus and the event bus is facilitated by an application of the <a href=../event-sourcing/ >Event Sourcing pattern</a>, which keeps a change log that is suitable for publishing. Event sourcing maintains not only the current state of the data but also the history of how that current state was reached. For each command on the command bus, the write model performs these tasks to process the command:</p> <ul> <li>Logs the change</li> <li>Updates the database with the change</li> <li>Creates an update event describing the change and publishes it to the event bus</li> </ul> <p>The changes that are logged can be the commands from the command bus or the update events published to the event bus</p> <h2 id=considerations>Considerations<a class=headerlink href=#considerations title="Permanent link">&para;</a></h2> <p>Keep these decisions in mind while applying this pattern:</p> <ul> <li><strong>Client impact</strong>: Applying CQRS not only changes how data is stored and accessed, but also changes the APIs that clients use to access data. This means that each client must be redesigned to use the new APIs.</li> <li><strong>Riskiness</strong>: A lot of the complexity of the pattern solution involves duplicating the data in two databases and keeping them synchronized. Risk comes from querying data that is stale or downright wrong because of problems with the synchronization.</li> <li><strong>Eventual consistency</strong>: Clients querying data must expect that updates will have latency. In a microservices architecture, eventual data consistency is a given and acceptable in many of cases.</li> <li><strong>Command queuing</strong>: Using a command bus as part of the write solution to queue the commands is optional but powerful. In addition to the benefits of queuing, the command objects can easily be stored in the change log and easily be converted into notification events. (In the next section, we illustrate a way to use event bus to queue commands as well.)</li> <li><strong>Change log</strong>: The log of changes to the database of record can be either the list of commands from the command bus or the list of event notifications published on the event bus. The Event Sourcing pattern assumes it’s a log of events, but that pattern doesn’t include the command bus. An event list may be easier to scan as a history, whereas a command list is easier to replay.</li> <li><strong>Create keys</strong>: Strick interpretation of the Command Query Separation (CQS) pattern says that command operations do not have return types. A possible exception is commands that create data: An operation that creates a new record or document typically returns the key for accessing the new data, which is convenient for the client. However, if the create operation is invoked asynchronously by a command on a command bus, the write model will need to perform a callback on the client to return the key.</li> <li><strong>Messaging queues and topics</strong>: While messaging is used to implement both the command bus and event bus, the two busses use messaging differently. The command bus guarantees exactly once delivery. The event bus broadcasts each event to all interested event processors.</li> <li><strong>Query database persistence</strong>: The database of record is always persistent. The query database is a cache that can be a persistent cache or an in-memory cache. If the cache is in-memory and is lost, it must be rebuilt completely from the database of record.</li> <li><strong>Security</strong>: Controls on reading data and updating data can be applied separately using the two parts of the solution.</li> </ul> <h2 id=combining-event-sourcing-and-cqrs>Combining event sourcing and CQRS<a class=headerlink href=#combining-event-sourcing-and-cqrs title="Permanent link">&para;</a></h2> <p>The CQRS application pattern is frequently associated with event sourcing: when doing event sourcing and domain driven design, we event source the aggregates or root entities. Aggregate creates events that are persisted. On top of the simple create, update and read by ID operations, the business requirements want to perform complex queries that can't be answered by a single aggregate. By just using event sourcing to be able to respond to a query like "what are the orders of a customer", then we have to rebuild the history of all orders and filter per customer. It is a lot of computation. This is linked to the problem of having conflicting domain models between query and persistence.</p> <p>As introduced in previous section, creations and updates are done as state notification events (change of state), and are persisted in the event log/store. The following figure, presents two separate microservices, one supporting the write model, and multiple other supporting the queries:</p> <p><img alt=5 src=images/cqrs-es-api.png></p> <p>The query part is separate processes that consume change log events and build a projection for future queries. The "write" part may persist in SQL while the read may use document oriented database with strong indexing and query capabilities. Or use in-memory database, or distributed cache... They do not need to be in the same language. With CQRS and ES the projections are retroactives. New query equals implementing new projection and read the events from the beginning of time or the recent committed state and snapshot. Read and write models are strongly decoupled and can evolve independently. It is important to note that the 'Command' part can still handle simple queries, primary-key based, like get order by id, or queries that do not involve joins.</p> <p>The event backbone, use a pub/sub model, and Kafka is a good candidate as an implementation technology.</p> <p>With this structure, the <code>Read model</code> microservice will most likely consume events from multiple topics to build the data projection based on joining those data streams. A query, to assess if the cold-chain was respected on the fresh food order shipment, will go to the voyage, container metrics, and order to be able to answer this question. This is where CQRS shines.</p> <p>We can note that, we can separate the API definition and management in a API gateway.</p> <p>The <a href=https://github.com/ibm-cloud-architecture/refarch-kc-order-ms>shipment order microservice</a> is implementing this pattern.</p> <p>Some implementation items to consider:</p> <ul> <li><strong>Consistency</strong> (ensure the data constraints are respected for each data transaction): CQRS without event sourcing has the same consistency guarantees as the database used to persist data and events. With Event Sourcing the consistency could be different, one for the write model and one for the read model. On write model, strong consistency is important to ensure the current state of the system is correct, so it leverages transaction, lock and sharding. On read side, we need less consistency, as they mostly work on stale data. Locking data on the read operation is not reasonable.</li> <li><strong>Scalability</strong>: Separating read and write as two different microservices allows for high availability. Caching at the read level can be used to increase performance response time, and can be deployed as multiple standalone instances (Pods in Kubernetes). It is also possible to separate the query implementations between different services. Functions as service / serverless are good technology choices to implement complex queries.</li> <li><strong>Availability</strong>: The write model sacrafices consistency for availability. This is a fact. The read model is eventually consistent so high availability is possible. In case of failure the system disables the writing of data but still is able to read them as they are served by different databases and services.</li> </ul> <p>With CQRS, the write model can evolve over time without impacting the read model, as long as the event model doesn't change. The read model requires additional tables, but they are often simpler and easier to understand.</p> <p>CQRS results in an increased number of objects, with commands, operations, events,... and packaging in deployable components or containers. It adds potentially different type of data sources. It is more complex.</p> <p>Some challenges to always consider:</p> <ul> <li>How to support event structure version management?</li> <li>How much data to keep in the event store (history)?</li> <li>How to adopt data duplication which results to eventual data consistency?.</li> </ul> <p>The CQRS pattern was introduced by <a href="https://www.youtube.com/watch?v=JHGkaShoyNs">Greg Young</a>, and described in <a href=https://martinfowler.com/bliki/CQRS.html>Martin Fowler's work on microservices.</a></p> <p>As you can see in previous figure, as soon as we see two arrows from the same component, we have to ask ourselves how does it work: the write model has to persist Order in its own database and then sends OrderCreated event to the topic... Should those operations be atomic and controlled with transaction? We detail this in next section.</p> <h2 id=keeping-the-write-model-on-mainframe>Keeping the write model on Mainframe<a class=headerlink href=#keeping-the-write-model-on-mainframe title="Permanent link">&para;</a></h2> <p>It is very important to note that the system of records and transaction processing is still easier to run on mainframe to support strong consistency. But with the move to cloud native development, it does not mean we have to move all the system of records to the cloud. Data pipelines can be put in place, but CQRS should help by keeping the write model on the current system of records and without impacting the current MIPS utilization move data in the eventual consistency workd of the cloud native, distributed computing world.</p> <p><img alt src=images/cqrs-mainframe.png></p> <p>In the figure above, the write model follows the current transaction processing on the mainframce, change data capture push data to Event backbone for getting real time visibility into the distributed world. The read is the costly operation, dues to the joins to be done to build the projection views needed to expose data depending of the business use cases. This is more true with distributed microservices. All the write operations for the business entities kept in the mainframe's system of records are still done via the transaction. Reference data can be injected in one load job to topic and persisted in the event store so streaming applications can leverage them by joining with transactional data. </p> <h2 id=the-consistency-challenges>The consistency challenges<a class=headerlink href=#the-consistency-challenges title="Permanent link">&para;</a></h2> <p>As introduced in the previous section, there is a potential problem of data inconsistency: once a command saves changes into the database, the consumers do not see the new or updated data until event notification completes processing.</p> <p>With traditional Java service, using JPA and JMS, the save and send operations can be part of the same XA transaction and both succeed or fail.</p> <p>With event sourcing pattern, the source of trust is the event source, which acts as a version control system, as shown in the diagram below.</p> <p><img alt=6 src=images/cqrs-es-error-handling.png></p> <p>The steps for syncronizing changes to the data are:</p> <ol> <li>The write model creates the event and publishes it</li> <li>The consumer receives the event and extracts its payload</li> <li>The consumer updates its local datasource with the payload data</li> <li>If the consumer fails to process the update, it can persist the event to an error log</li> <li>Each error in the log can be replayed</li> <li>A command line interface replays an event via an admin API, which searches in the topic using this order id to replay the save operation</li> </ol> <p>This implementation causes a problem for the <code>createOrder(order): string</code> operation: The Order Service is supposed to return the new order complete with the order id that is a unique key, a key most likely created by the database. If updating the database fails, there is no new order yet and so no database key to use as the order ID. To avoid this problem, if the underlying technology supports assigning the new order's key, the service can generate the order ID and use that as the order's key in the database.</p> <p>It is important to clearly study the Kafka consumer API and the different parameters on how to support the read offset. We are addressing those implementation best practices in <a href=../../technology/kafka-consumers>our consumer note.</a></p> <h3 id=cqrs-and-change-data-capture>CQRS and Change Data Capture<a class=headerlink href=#cqrs-and-change-data-capture title="Permanent link">&para;</a></h3> <p>There are other ways to support this dual operations level:</p> <ul> <li>When using Kafka, <a href=https://kafka.apache.org/documentation/#connect>Kafka Connect</a> has the capability to subscribe to databases via JDBC, allowing to poll tables for updates and then produce events to Kafka.</li> <li>There is an open-source change data capture solution based on extracting change events from database transaction logs, <a href=https://debezium.io/ >Debezium</a> that helps to respond to insert, update and delete operations on databases and generate events accordingly. It supports databases like MySQL, Postgres, MongoDB and others.</li> <li>Write the order to the database and in the same transaction write to an event table (<a href=../intro#transactional-outbox>"outbox pattern"</a>). Then use a polling to get the events to send to Kafka from this event table and delete the row in the table once the event is sent.</li> <li>Use the Change Data Capture from the database transaction log and generate events from this log. The IBM <a href=https://www.ibm.com/support/knowledgecenter/cs/SSTRGZ_10.2.0/com.ibm.cdcdoc.mcadminguide.doc/concepts/overview_of_cdc.html>Infosphere CDC</a> product helps to implement this pattern. For more detail about this solution see <a href=https://www.ibm.com/cloud/garage/dte/producttour/ibm-infosphere-data-replication-product-tour>this product tour</a>.</li> </ul> <p>The CQRS implementation using CDC will look like in the following diagram:</p> <p><img alt src=images/cqrs-cdc.png></p> <p>What is important to note is that the event needs to be flexible on the data payload. We are presenting a <a href=https://ibm-cloud-architecture.github.io/refarch-kc-order-ms/#data-and-event-model>event model</a> in the reference implementation.</p> <p>On the view side, updates to the view part need to be idempotent.</p> <h3 id=delay-in-the-view>Delay in the view<a class=headerlink href=#delay-in-the-view title="Permanent link">&para;</a></h3> <p>There is a delay between the data persistence and the availability of the data in the Read model. For most business applications, it is perfectly acceptable. In web based data access most of the data are at stale.</p> <p>When there is a need for the client, calling the query operation, to know if the data is up-to-date, the service can define a versioning strategy. When the order data was entered in a form within a single page application like our <a href=https://github.com/ibm-cloud-architecture/refarch-kc-ui>kc- user interface</a>, the "create order" operation should return the order with its unique key freshly created and the Single Page Application will have the last data. Here is an example of such operation:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=nd>@POST</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=kd>public</span><span class=w> </span><span class=n>Response</span><span class=w> </span><span class=nf>create</span><span class=p>(</span><span class=n>OrderCreate</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>    </span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Order</span><span class=p>(</span><span class=n>UUID</span><span class=p>.</span><span class=na>randomUUID</span><span class=p>().</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>dto</span><span class=p>.</span><span class=na>getProductID</span><span class=p>(),...);</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>    </span><span class=c1>// ...</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>Response</span><span class=p>.</span><span class=na>ok</span><span class=p>().</span><span class=na>entity</span><span class=p>(</span><span class=n>order</span><span class=p>).</span><span class=na>build</span><span class=p>()</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=p>}</span>
</code></pre></div> <h3 id=schema-change>Schema change<a class=headerlink href=#schema-change title="Permanent link">&para;</a></h3> <p>What to do when we need to add attribute to event?. So we need to create a versioninig schema for event structure. You need to use flexible schema like json schema, <a href=https://avro.apache.org/docs/current/ >Apache Avro</a> or <a href=https://developers.google.com/protocol-buffers/ >protocol buffer</a> and may be, add an event adapter (as a function?) to translate between the different event structures.</p> <h3 id=code-reference>Code reference<a class=headerlink href=#code-reference title="Permanent link">&para;</a></h3> <ul> <li>The following project includes two sub modules, each deployable as a microservice to illustrate the command and query part: <a href=https://github.com/ibm-cloud-architecture/refarch-kc-order-ms>https://github.com/ibm-cloud-architecture/refarch-kc-order-ms</a></li> </ul> <details class=-> <summary>Further readings</summary> <ul> <li><a href=https://www.codeproject.com/Articles/555855/Introduction-to-CQRS>https://www.codeproject.com/Articles/555855/Introduction-to-CQRS</a></li> <li><a href=http://udidahan.com/2009/12/09/clarified-cqrs/ >http://udidahan.com/2009/12/09/clarified-cqrs</a></li> <li><a href=https://martinfowler.com/bliki/CQRS.html>https://martinfowler.com/bliki/CQRS.html</a></li> <li><a href=https://microservices.io/patterns/data/cqrs.html>https://microservices.io/patterns/data/cqrs.html</a></li> <li><a href=https://community.risingstack.com/when-to-use-cqrs>https://community.risingstack.com/when-to-use-cqrs</a></li> <li><a href=https://dzone.com/articles/concepts-of-cqrs>https://dzone.com/articles/concepts-of-cqrs</a></li> <li><a href=https://martinfowler.com/bliki/CommandQuerySeparation.html>https://martinfowler.com/bliki/CommandQuerySeparation.html</a></li> <li><a href=https://www.martinfowler.com/eaaCatalog/domainModel.html>https://www.martinfowler.com/eaaCatalog/domainModel.html</a></li> <li><a href=https://dddcommunity.org/learning-ddd/what_is_ddd/ >https://dddcommunity.org/learning-ddd/what_is_ddd/</a></li> <li><a href=https://martinfowler.com/bliki/EvansClassification.html>https://martinfowler.com/bliki/EvansClassification.html</a></li> <li><a href=https://martinfowler.com/bliki/DDD_Aggregate.html>https://martinfowler.com/bliki/DDD_Aggregate.html</a></li> <li><a href=https://martinfowler.com/eaaCatalog/dataTransferObject.html>https://martinfowler.com/eaaCatalog/dataTransferObject.html</a></li> <li><a href=https://en.wikipedia.org/wiki/Command_pattern>https://en.wikipedia.org/wiki/Command_pattern</a></li> <li><a href=https://www.pearson.com/us/higher-education/program/Gamma-Design-Patterns-Elements-of-Reusable-Object-Oriented-Software/PGM14333.html>https://www.pearson.com/us/higher-education/program/Gamma-Design-Patterns-Elements-of-Reusable-Object-Oriented-Software/PGM14333.html</a></li> </ul> </details> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright © 2022 IBM </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/ibm-cloud-architecture target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://twitter.com/agileitarchitecture target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "content.tooltips", "navigation.instant", "navigation.tabs.sticky", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.1e8ae164.min.js></script> </body> </html>