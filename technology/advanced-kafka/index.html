<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="IBM Automation - Event-Driven Solution - Sharing knowledge"><meta name=author content="Jerome Boyer"><link href=https://ibm-cloud-architecture.github.com/refarch-eda/technology/advanced-kafka/ rel=canonical><link href=../avro-schemas/ rel=prev><link href=../kafka-streams/ rel=next><link rel=icon href=../../assets/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.17"><title>Advanced Concepts - IBM Automation - Event-driven Solution - Sharing knowledge</title><link rel=stylesheet href=../../assets/stylesheets/main.bcfcd587.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#kafka-advanced-concepts class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="IBM Automation - Event-driven Solution - Sharing knowledge" class="md-header__button md-logo" aria-label="IBM Automation - Event-driven Solution - Sharing knowledge" data-md-component=logo> <img src=../../images/es-icon.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> IBM Automation - Event-driven Solution - Sharing knowledge </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Advanced Concepts </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ibm-cloud-architecture/refarch-eda title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> ibm-cloud-architecture/refarch-eda </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="IBM Automation - Event-driven Solution - Sharing knowledge" class="md-nav__button md-logo" aria-label="IBM Automation - Event-driven Solution - Sharing knowledge" data-md-component=logo> <img src=../../images/es-icon.png alt=logo> </a> IBM Automation - Event-driven Solution - Sharing knowledge </label> <div class=md-nav__source> <a href=https://github.com/ibm-cloud-architecture/refarch-eda title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> ibm-cloud-architecture/refarch-eda </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../news/ class=md-nav__link> <span class=md-ellipsis> What's new </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Introduction </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Introduction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../introduction/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../introduction/reference-architecture/ class=md-nav__link> <span class=md-ellipsis> Reference Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../introduction/usecases/ class=md-nav__link> <span class=md-ellipsis> Business Use Cases </span> </a> </li> <li class=md-nav__item> <a href=../../introduction/target-audiences/ class=md-nav__link> <span class=md-ellipsis> Target Audiences </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Learning Journey </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Learning Journey </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../journey/101/ class=md-nav__link> <span class=md-ellipsis> Get started (101 content) </span> </a> </li> <li class=md-nav__item> <a href=../../journey/201/ class=md-nav__link> <span class=md-ellipsis> Deeper dive (201 content) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../concepts/terms-and-definitions/ class=md-nav__link> <span class=md-ellipsis> Terms & Definitions </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/integration/ class=md-nav__link> <span class=md-ellipsis> Agile Integration </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/events-versus-messages/ class=md-nav__link> <span class=md-ellipsis> Event streaming versus Queuing </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/fit-to-purpose/ class=md-nav__link> <span class=md-ellipsis> Fit for purpose </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/model/ class=md-nav__link> <span class=md-ellipsis> Devising the data models </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/flow-architectures/ class=md-nav__link> <span class=md-ellipsis> Flow Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/service-mesh/ class=md-nav__link> <span class=md-ellipsis> Service mesh </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Advantages of EDA </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Advantages of EDA </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../advantages/microservice/ class=md-nav__link> <span class=md-ellipsis> Microservice decoupling </span> </a> </li> <li class=md-nav__item> <a href=../../advantages/reactive/ class=md-nav__link> <span class=md-ellipsis> Reactive systems </span> </a> </li> <li class=md-nav__item> <a href=../../advantages/resiliency/ class=md-nav__link> <span class=md-ellipsis> Resiliency </span> </a> </li> <li class=md-nav__item> <a href=../../advantages/scalability/ class=md-nav__link> <span class=md-ellipsis> Scalability </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Patterns in EDA </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Patterns in EDA </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../patterns/intro/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../patterns/event-sourcing/ class=md-nav__link> <span class=md-ellipsis> Event Sourcing </span> </a> </li> <li class=md-nav__item> <a href=../../patterns/cqrs/ class=md-nav__link> <span class=md-ellipsis> CQRS </span> </a> </li> <li class=md-nav__item> <a href=../../patterns/saga/ class=md-nav__link> <span class=md-ellipsis> Saga </span> </a> </li> <li class=md-nav__item> <a href=../../patterns/dlq/ class=md-nav__link> <span class=md-ellipsis> Dead Letter Queue </span> </a> </li> <li class=md-nav__item> <a href=../../patterns/topic-replication/ class=md-nav__link> <span class=md-ellipsis> Topic Replication </span> </a> </li> <li class=md-nav__item> <a href=../../patterns/data-pipeline/ class=md-nav__link> <span class=md-ellipsis> Data Intensive App </span> </a> </li> <li class=md-nav__item> <a href=../../patterns/realtime-analytics/ class=md-nav__link> <span class=md-ellipsis> Near real-time analytics </span> </a> </li> <li class=md-nav__item> <a href=../../patterns/api-mgt/ class=md-nav__link> <span class=md-ellipsis> API management </span> </a> </li> <li class=md-nav__item> <a href=../../patterns/cep/ class=md-nav__link> <span class=md-ellipsis> Situational decision </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> Methodology </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Methodology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../methodology/event-storming/ class=md-nav__link> <span class=md-ellipsis> Event Storming </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/domain-driven-design/ class=md-nav__link> <span class=md-ellipsis> Domain-Driven Design </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/data-intensive/ class=md-nav__link> <span class=md-ellipsis> Data Intensive App Development </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/data-lineage/ class=md-nav__link> <span class=md-ellipsis> Data lineage </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/governance/ class=md-nav__link> <span class=md-ellipsis> Governance </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_9 checked> <label class=md-nav__link for=__nav_9 id=__nav_9_label tabindex=0> <span class=md-ellipsis> Technology </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=true> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> Technology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../kafka-overview/ class=md-nav__link> <span class=md-ellipsis> Kafka Overview </span> </a> </li> <li class=md-nav__item> <a href=../event-streams/ class=md-nav__link> <span class=md-ellipsis> Event Streams </span> </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/eda-tech-academy/demo/ class=md-nav__link> <span class=md-ellipsis> Event Streams Demo Script </span> </a> </li> <li class=md-nav__item> <a href=../faq/ class=md-nav__link> <span class=md-ellipsis> Kafka FAQ </span> </a> </li> <li class=md-nav__item> <a href=../mq/ class=md-nav__link> <span class=md-ellipsis> MQ in EDA context </span> </a> </li> <li class=md-nav__item> <a href=../kafka-producers/ class=md-nav__link> <span class=md-ellipsis> Kafka Producers </span> </a> </li> <li class=md-nav__item> <a href=../kafka-consumers/ class=md-nav__link> <span class=md-ellipsis> Kafka Consumers </span> </a> </li> <li class=md-nav__item> <a href=../avro-schemas/ class=md-nav__link> <span class=md-ellipsis> Avro Schema </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Advanced Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Advanced Concepts </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#high-availability class=md-nav__link> <span class=md-ellipsis> High Availability </span> </a> <nav class=md-nav aria-label="High Availability"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#replication-and-partition-leadership class=md-nav__link> <span class=md-ellipsis> Replication and partition leadership </span> </a> </li> <li class=md-nav__item> <a href=#high-availability-in-the-context-of-kubernetes-deployment class=md-nav__link> <span class=md-ellipsis> High Availability in the context of Kubernetes deployment </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#performance-considerations class=md-nav__link> <span class=md-ellipsis> Performance Considerations </span> </a> <nav class=md-nav aria-label="Performance Considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#resilience class=md-nav__link> <span class=md-ellipsis> Resilience </span> </a> </li> <li class=md-nav__item> <a href=#throughput class=md-nav__link> <span class=md-ellipsis> Throughput </span> </a> </li> <li class=md-nav__item> <a href=#payload-size class=md-nav__link> <span class=md-ellipsis> Payload size </span> </a> </li> <li class=md-nav__item> <a href=#parameter-considerations class=md-nav__link> <span class=md-ellipsis> Parameter considerations </span> </a> </li> <li class=md-nav__item> <a href=#openshift-specifics class=md-nav__link> <span class=md-ellipsis> Openshift specifics </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#disaster-recovery class=md-nav__link> <span class=md-ellipsis> Disaster Recovery </span> </a> </li> <li class=md-nav__item> <a href=#solution-considerations class=md-nav__link> <span class=md-ellipsis> Solution Considerations </span> </a> <nav class=md-nav aria-label="Solution Considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#topics class=md-nav__link> <span class=md-ellipsis> Topics </span> </a> </li> <li class=md-nav__item> <a href=#producers class=md-nav__link> <span class=md-ellipsis> Producers </span> </a> </li> <li class=md-nav__item> <a href=#consumers class=md-nav__link> <span class=md-ellipsis> Consumers </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../kafka-streams/ class=md-nav__link> <span class=md-ellipsis> Kafka Streams </span> </a> </li> <li class=md-nav__item> <a href=../kafka-connect/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect </span> </a> </li> <li class=md-nav__item> <a href=../event-streams/es-maas/security/ class=md-nav__link> <span class=md-ellipsis> Kafka security </span> </a> </li> <li class=md-nav__item> <a href=../kafka-monitoring/ class=md-nav__link> <span class=md-ellipsis> Kafka Monitoring </span> </a> </li> <li class=md-nav__item> <a href=../kafka-mirrormaker/ class=md-nav__link> <span class=md-ellipsis> Mirror Maker 2 </span> </a> </li> <li class=md-nav__item> <a href=../security/ class=md-nav__link> <span class=md-ellipsis> Security </span> </a> </li> <li class=md-nav__item> <a href=../flink/ class=md-nav__link> <span class=md-ellipsis> Apache Flink </span> </a> </li> <li class=md-nav__item> <a href=../spring/ class=md-nav__link> <span class=md-ellipsis> Spring cloud </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_10> <label class=md-nav__link for=__nav_10 id=__nav_10_label tabindex=0> <span class=md-ellipsis> Use Cases </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_10_label aria-expanded=false> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> Use Cases </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../use-cases/gitops/ class=md-nav__link> <span class=md-ellipsis> Event-driven solution GitOps </span> </a> </li> <li class=md-nav__item> <a href=../event-streams/es-cp4i/ class=md-nav__link> <span class=md-ellipsis> Deploy Event-Streams </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/connect-s3/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect - S3 </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/connect-cos/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect - COS </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/connect-jdbc/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect - jdbc </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/connect-mq/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect - MQ </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/connect-rabbitmq/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect - Rabbitmq </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/kafka-streams/ class=md-nav__link> <span class=md-ellipsis> Kafka Streams labs </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/db2-debezium/ class=md-nav__link> <span class=md-ellipsis> DB2 - CDC Debezium - Outbox </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/kafka-mm2/ class=md-nav__link> <span class=md-ellipsis> Mirror maker 2 labs </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/schema-registry-on-cloud/ class=md-nav__link> <span class=md-ellipsis> Schema registry ES on Cloud </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/schema-registry-on-ocp/ class=md-nav__link> <span class=md-ellipsis> Schema registry </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/monitoring-on-cloud/ class=md-nav__link> <span class=md-ellipsis> Monitoring ES on Cloud </span> </a> </li> <li class=md-nav__item> <a href=../../use-cases/monitoring-on-ocp/ class=md-nav__link> <span class=md-ellipsis> Monitoring ES </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_11> <label class=md-nav__link for=__nav_11 id=__nav_11_label tabindex=0> <span class=md-ellipsis> Scenarios </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_11_label aria-expanded=false> <label class=md-nav__title for=__nav_11> <span class="md-nav__icon md-icon"></span> Scenarios </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../scenarios/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/refarch-kc/ class=md-nav__link> <span class=md-ellipsis> Reefer Shipment Solution </span> </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/vaccine-solution-main/ class=md-nav__link> <span class=md-ellipsis> Vaccine at Scale </span> </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/eda-rt-inventory-gitops class=md-nav__link> <span class=md-ellipsis> Near real-time Inventory </span> </a> </li> <li class=md-nav__item> <a href=../../scenarios/saga-orchestration/ class=md-nav__link> <span class=md-ellipsis> SAGA with MQ Orchestration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../additional-reading/ class=md-nav__link> <span class=md-ellipsis> Additional reading </span> </a> </li> <li class=md-nav__item> <a href=../../contribute/ class=md-nav__link> <span class=md-ellipsis> Contribute to this Site </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#high-availability class=md-nav__link> <span class=md-ellipsis> High Availability </span> </a> <nav class=md-nav aria-label="High Availability"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#replication-and-partition-leadership class=md-nav__link> <span class=md-ellipsis> Replication and partition leadership </span> </a> </li> <li class=md-nav__item> <a href=#high-availability-in-the-context-of-kubernetes-deployment class=md-nav__link> <span class=md-ellipsis> High Availability in the context of Kubernetes deployment </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#performance-considerations class=md-nav__link> <span class=md-ellipsis> Performance Considerations </span> </a> <nav class=md-nav aria-label="Performance Considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#resilience class=md-nav__link> <span class=md-ellipsis> Resilience </span> </a> </li> <li class=md-nav__item> <a href=#throughput class=md-nav__link> <span class=md-ellipsis> Throughput </span> </a> </li> <li class=md-nav__item> <a href=#payload-size class=md-nav__link> <span class=md-ellipsis> Payload size </span> </a> </li> <li class=md-nav__item> <a href=#parameter-considerations class=md-nav__link> <span class=md-ellipsis> Parameter considerations </span> </a> </li> <li class=md-nav__item> <a href=#openshift-specifics class=md-nav__link> <span class=md-ellipsis> Openshift specifics </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#disaster-recovery class=md-nav__link> <span class=md-ellipsis> Disaster Recovery </span> </a> </li> <li class=md-nav__item> <a href=#solution-considerations class=md-nav__link> <span class=md-ellipsis> Solution Considerations </span> </a> <nav class=md-nav aria-label="Solution Considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#topics class=md-nav__link> <span class=md-ellipsis> Topics </span> </a> </li> <li class=md-nav__item> <a href=#producers class=md-nav__link> <span class=md-ellipsis> Producers </span> </a> </li> <li class=md-nav__item> <a href=#consumers class=md-nav__link> <span class=md-ellipsis> Consumers </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=kafka-advanced-concepts>Kafka Advanced Concepts<a class=headerlink href=#kafka-advanced-concepts title="Permanent link">&para;</a></h1> <h2 id=high-availability>High Availability<a class=headerlink href=#high-availability title="Permanent link">&para;</a></h2> <p>As a distributed cluster, Kafka brokers ensure high availability to process records. Topic has replication factor to support not loosing data in case of broker failure. You need at least 3 brokers to ensure availability and a replication factor set to 3 for each topic, so no data should be lost. But for production deployment, it is strongly recommended to use 5 brokers cluster to ensure the quorum is always set, even when doing product upgrade. Replica factor can still be set to 3.</p> <p>The brokers need to run on separate physical machines, and when cluster extends over multiple availability zones, a <a href=https://strimzi.io/docs/operators/latest/using.html#type-Rack-reference>rack awareness</a> configuration can be defined. The <strong>rack</strong> concept can represent an availability zone, data center, or an actual rack in your data center. Enabling rack awareness is done in a cluster definition (see Strimzi):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>  </span><span class=nt>kafka</span><span class=p>:</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>    </span><span class=nt>rack</span><span class=p>:</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>      </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">topology.kubernetes.io/zone</span>
</code></pre></div> <p>For Zookeeper 3,5,7 nodes are needed depending of the number of objects to manage. You can start with 3 and add nodes overtime.</p> <h3 id=replication-and-partition-leadership>Replication and partition leadership<a class=headerlink href=#replication-and-partition-leadership title="Permanent link">&para;</a></h3> <p>Partition enables data locality, elasticity, scalability, high performance, parallelism, and fault tolerance. Each partition is replicated at least 3 times and allocated in different brokers. One replicas is the <strong>leader</strong>. In the case of broker failure (broker 1 in figure below), one of the existing replica in the remaining running brokers will take the <strong>leader</strong> role as soon as the broker is identified as not responding:</p> <p><img alt="Replication and partition leadership" src=images/kafka-ha.png></p> <p>The record key in each record sent by producer, determines the partition allocation in <strong>Kafka</strong>: the records with the same key (hashcode of the key to be exact) will be in the same partition (It is possible to use more complex behavior via configuration and even code).</p> <p>As Kafka is keeping its cluster states in <a href=http://zookeeper.apache.org/ >Apache Zookeeper</a>, you also need to have at least a three node cluster for zookeeper. From version 2.8, it is possible to do not use Zookeeper, but not yet for production deployment: the brokers are using a Raft quorum algorithm, and an internal topic to keep state and metadata (See the <a href=https://kafka.apache.org/documentation/#brokerconfigs_process.roles>process.roles property</a> from the broker configuration).</p> <p>Writes to Zookeeper are only be performed on changes to the membership of consumer groups or on changes to the Kafka cluster topology itself. Assuming you are using the most recent Kafka version, it is possible to have a unique zookeeper cluster for multiple kafka clusters. But the latency between Kafka and Zookeeper needs to be under few milliseconds (&lt; 15ms) anyway.</p> <p>Zookeepers and Brokers should have high availability communication via dual network, and each broker and node allocated on different racks and blades.</p> <p><img alt="Dual network" src=images/ha-comp.png></p> <p>To contact the cluster, consumers and producers are using a list of bootstrap server names (also named <code>advertiser.listeners</code>). The list is used for cluster discovery, it does not need to keep the full set of server names or IP addresses. A Kafka cluster has exactly one broker that acts as the controller.</p> <p>Per design Kafka aims to run within a single data center. But it is still recommended to use multiple racks connected with low latency dual networks. With multiple racks you will have better fault tolerance, as one rack failure will impact only one broker. There is a configuration property to assign kafka broker using rack awareness. (See <a href=https://kafka.apache.org/documentation/#brokerconfigs>the broker configuration</a> from the product documentation).</p> <p>As introduced on the <a href=../kafka-overview/#topics>topic introduction section</a>, data are replicated between brokers. The following diagram illustrates the best case scenario where followers fetch data from the partition leader, and acknowledge the replications:</p> <p><img alt src=images/topic-replica-seq.png width=1000></p> <p>Usually replicas is done in-sync, and the configuration settings specify the number of <code>in-sync</code> replicas needed: for example, a replica 3 can have a minimum in-sync of 2, to tolerate 1 (= 3-2) out of sync replica (1 broker outage).</p> <p>The leader maintains a set of in-sync-replicas (ISR) broker list: all the nodes which are up-to-date with the leader’s log, and actively acknowledging new writes. Every write goes through the leader and is propagated to every node in the In Sync Replica set.</p> <p>Followers consume messages from the leader just as a normal Kafka consumer would and apply them to their own log. Having the followers pull from the leader has the nice property of allowing the follower to naturally batch together log entries they are applying to their log.</p> <p>Once all nodes in the ISR have acknowledged the request, the partition leader broker considers it committed, and can acknowledge to the producer.</p> <p>A message is considered committed when all in-sync replicas for that partition have applied this message to their log.</p> <p>If a leader fails, followers elect a new one. The partition leadership is dynamic and changes as servers come and go. Applications do not need to take specific actions to handle the change in the leadership of a partition. The Kafka client library automatically reconnects to the new leader, although you will see increased latency while the cluster settles: later we will see this problem with partition rebalancing. Any replica in the ISR is eligible to be elected leader.</p> <p><img alt src=images/topic-replica-fail.png width=1000></p> <p>When a leader waits to get acknowledge before committing a message there will be more potential leaders. With (#failure + 1) replicas there is no data lost. But there is a risk of having the single broker separated from the Zookeeper cluster when network partition occurs. To tolerate f failures, both the majority vote and the ISR approach will wait for the same number of replicas to acknowledge before committing a message.</p> <p>Having higher replicas number like 5, will duplicate 5 times the data (more disk used) and will impact throughput as data is sent 1+4 times over the network. Get acknowledgement will take a little bit more time too.</p> <p>Another important design distinction is that Kafka does not require that crashed nodes recover with all their data intact.  Kafka protocol by allowing a replica to rejoin the ISR, ensures that before rejoining, it must fully re-sync again even if it lost unflushed data in its crash.</p> <p>When a producer sends message, it can control how to get the response from the committed message: wait for all replicas to succeed, wait for one acknowledge, fire and forget. Consumers receive only committed messages.</p> <p>Always assess the latency requirements and consumers needs. Throughput is linked to the number of partitions within a topic and having more consumers running in parallel. Consumers and producers should better run on separate servers than the brokers nodes. Running in parallel, also means the order of event arrivals will be lost. Most of the time, consumers are processing events from a unique partition and Kafka records to partition assignment will guarantee that records with the same key hashcode will be in the same partition. So orders are preserved within a partition. But if consumer needs to read from multiple partitions and if ordered records is needed, the consumer needs to rebuild the order by implementing adhoc logic, based on time stamp.</p> <p>For high availability, assess any potential single point of failure, such as server, rack, network, power supply... We recommend reading <a href=https://ibm.github.io/event-streams/installing/planning/ >this event stream article</a> for planning your kafka on Kubernetes installation.</p> <p>For the consumers code maintenance, the re-creation of the consumer instance within the consumer group will trigger a partition rebalancing. This includes all the state of the aggregated data calculations that were persisted on disk. Until this process is finished real-time events are not processed. It is possible to limit this impact by setting the <code>group.initial.rebalance.delay.ms</code> to delay the rebalancing process once one instance of the consumer dies. Nevertheless the rebalancing will still occur when the updated consumer will rejoin the consumer group. </p> <p>When consumers are stream processing using Kafka streams, it is important to note that during the rollover the downstream processing will see a lag in event arrival: the time for the consumer to reread from the last committed offset. So if the end-to-end timing is becoming important, we need to setup a standby consumer group (group B). This consumer group has different name, but does the same processing logic, and is consuming the same events from the same topic as the active consumer group (group A). The difference is that they do not send events to the downstream topic until they are set up active. So the process is to set group B active while cluster A is set inactive. The downstream processing will not be impacted. Finally to be exhaustive, the control of the segment size for the change log topic, may be considered to avoid having the stream processing doing a lot of computation to reload its state when it restarts.</p> <p>To add new broker, you can deploy the runtime to a new server / rack / blade, and give a unique broker ID. Broker will process new topic, but it is possible to use thr <a href=https://access.redhat.com/documentation/en-us/red_hat_amq/7.4/html/using_amq_streams_on_red_hat_enterprise_linux_rhel/scaling_clusters>kafka-reassign-partitions </a> tool to migrate some existing topic/ partitions to the new server. The tool is used to reassign partitions across brokers. An ideal partition distribution would ensure even data load and partition sizes across all brokers.</p> <h3 id=high-availability-in-the-context-of-kubernetes-deployment>High Availability in the context of Kubernetes deployment<a class=headerlink href=#high-availability-in-the-context-of-kubernetes-deployment title="Permanent link">&para;</a></h3> <p>The combination of Kafka with Kubernetes seems to be a sound approach, but it is not that easy to achieve. Kubernetes workloads prefer to be stateless, Kafka is a stateful platform and manages its own brokers, and replications across known servers. It knows the underlying infrastructure. In Kubernetes, nodes and pods may change dynamically. Clients need to be able to access each of the broker directly once they get the connection metadata. Having a kubernetes service object which will round robin across all brokers in the cluster will not work with Kafka.</p> <p>The figure below illustrates a Kubernetes deployment, where Zookeeper and kafka brokers are allocated to 3 worker nodes, with some event driven microservices deployed in separate worker nodes. Those microservices are consumers and producers of events from one to many topics.</p> <p><img alt="kubernetes deployment" src=images/k8s-deploy.png></p> <p>The advantages of deploying Kafka on Kubernetes cluster is to facilitate the management of stateful sets, by scheduling both the persistence volume and broker pods in a clean rolling rehydration. Services add a logical name to access brokers for any deployed workload within the cluster. The virtual network also enables transparent TLS communication between components.</p> <p>For any Kubernetes deployment real high availability is constrained by the application / workload deployed on it. The Kubernetes platform supports high availability by having at least the following configuration:</p> <ul> <li>At least three master nodes (always an odd number of nodes). One is active at master, the others are in standby. The election of the master is using the quorum algorithm.</li> <li>At least three worker nodes, but with Zookeeper and Kafka clusters, we may need to have at least three more nodes as we do not want to have Zookeeper and Kafka brokers sharing the same host with other pods if the Kakfa traffic is supposed to grow.</li> <li>Externalize the management stack to three manager nodes</li> <li>Shared storage outside of the cluster to support private image registry, audit logs, and statefulset data persistence (like the Kakfa broker file systems).</li> <li>Use <code>etcd</code> cluster: See recommendations <a href=https://github.com/coreos/etcd/blob/master/Documentation/op-guide/clustering.md>from this article</a>. The virtual IP manager assigns virtual IP addresses to master and proxy nodes and monitors the health of the cluster. It leverages <code>etcd</code> for storing information, so it is important that <code>etcd</code> is high available too and connected to low latency network below 10ms.</li> </ul> <p>Traditionally disaster recovery and high availability were always consider separated subjects. Now active/active deployment where workloads are deployed in different data centers, is becoming a common IT's request.</p> <p>For sure, you need multiple Kafka Brokers, which will connect to the same ZooKeeper Ensemble running at least five nodes (you can tolerate the loss of one server during the planned maintenance of another server). One Zookeeper server acts as a lead and the two others as stand-by.</p> <p>The diagram above illustrates a simple deployment where Zookeeper servers and Kafka brokers are running in pods, in different worker nodes. It is a viable solution to start deploying solution on top of Kafka. When you have bigger cluster, it may be interesting to separate Zookeeper from <strong>Kafka</strong> nodes to limit the risk of failover, as Zookeeper keeps state of the <strong>Kafka</strong> cluster topology and metadata. You will limit to have both the Zookeeper leader and one Kafka broker dying at the same time. We use Kubernetes <a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity>anti-affinity</a> to ensure they are scheduled onto separate worker nodes that the ones used by Zookeeper. It uses the labels on pods with a rule like: <code>**Kafka** pod should not run on same node as zookeeper pods</code>.</p> <p>Here is an example of such spec:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=nt>metadata</span><span class=p>:</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">with-pod-affinity</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=nt>spec</span><span class=p>:</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>    </span><span class=nt>podAntiAffinity</span><span class=p>:</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>          </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>            </span><span class=nt>labelSelector</span><span class=p>:</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>            </span><span class=nt>matchExpressions</span><span class=p>:</span>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=w>              </span><span class=nt>values</span><span class=p>:</span>
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gc-zookeeper</span>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=w>          </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/hostname</span>
</code></pre></div> <p>We recommend reading the <a href=https://kubernetes.io/docs/tutorials/stateful-application/zookeeper>"running zookeeper in k8s tutorial"</a> for understanding such configuration.</p> <p>For optimum performance, provision a <strong>fast storage class</strong> for persistence volume.</p> <p><strong>Kafka</strong> uses the <code>log.dirs</code> property to configure the driver to persist logs. So you need to define multiple volumes/ drives to support <code>log.dirs</code>.</p> <p>Zookeeper should not be used by other applications deployed in k8s cluster, it has to be dedicated for one <strong>Kafka</strong> cluster only.</p> <p>In a multi-cluster configuration being used for disaster recovery purposes, messages sent between clusters will have different offsets in the two clusters. It is usual to use timestamps for position information when restarting applications for recovery after a disaster.</p> <p>For <strong>Kafka</strong> streaming with stateful processing like joins, event aggregation and correlation coming from multiple partitions, it is not easy to achieve high availability cross clusters: in the strictest case every event must be processed by the streaming service exactly once. Which means:</p> <ul> <li>producer emits data to different sites and be able to re-emit in case of failure. Brokers are known by producer via a list of hostnames and port numbers.</li> <li>communications between Zookeepers and cluster nodes are redundant and safe for data losses</li> <li>consumers ensure idempotence... They have to tolerate data duplication and manage data integrity in their persistence layer.</li> </ul> <p>Within Kafka's boundary, data will not be lost, when doing proper configuration, also to support high availability the complexity moves to the producer and the consumer implementation.</p> <p><strong>Kafka</strong> configuration is an art and you need to tune the parameters by use case:</p> <ul> <li>Partition replication for at least 3 replicas. Recall that in case of node failure, coordination of partition re-assignments is provided with ZooKeeper.</li> <li>End to end latency needs to be measured from producer (when a message is sent) to consumer (when it is read). A consumer is able to get a message when the brokers finish replicating to all in-synch replicas.</li> <li>Use the producer buffering capability to pace the message to the broker. Can use memory or time based threshold via producer properties.</li> <li>Define the number of partitions to drive consumer parallelism. More consumers running in parallel the higher is the throughput. When using multiple partitions the global ordering of message is lost.</li> <li>Assess the retention hours to control when old messages in topic can be deleted. It is possible to keep messages forever, and for some application it makes fully sense.</li> <li>Control the maximum message size the server can receive.</li> </ul> <p>Zookeeper is not CPU intensive and each server should have a least 2 GB of heap space and 4GB reserved. Two CPUs per server should be sufficient. Servers keep their entire state machine in memory, and write every mutation to a durable WAL (Write Ahead Log) on persistent storage. To prevent the WAL from growing without bound, ZooKeeper servers periodically snapshot their in memory state to storage. Use fast and dynamically provisioned persistence storage for both WAL and snapshot.</p> <h2 id=performance-considerations>Performance Considerations<a class=headerlink href=#performance-considerations title="Permanent link">&para;</a></h2> <p>Performance will vary depending of the current Kafka broker nodes load: in Kubernetes deployment, with small production topology, nodes may be shared with other pods. It is recommended to control the environment with dedicated nodes for Kafka to achieve higher throughput.<br> Performance will always depend on numerous factors including message throughput, message size, hardware, configuration settings, ...</p> <p>Performance may be linked to different focuses:</p> <ul> <li>Resilience: ensuring replication and not loosing data</li> <li>Throughput: ensuring message processing performance</li> <li>Payload size: support larger message</li> </ul> <h3 id=resilience>Resilience<a class=headerlink href=#resilience title="Permanent link">&para;</a></h3> <p>When defining a topic, we need to specify the replicas factor to match the be at least 3 and then set the minimum number of in-sync replicas that specifies how may replicas must acknowledge a write to satisfy a producer that requests acknowledgments from all replicas. (<code>min.insync.replicas</code>).</p> <p>The replication of message data between brokers can consume a lot of network bandwidth so isolating replication traffic from application traffic can benefit performance. To achieve this, all replication traffic is configured to flow on a dedicated internal network.</p> <h3 id=throughput>Throughput<a class=headerlink href=#throughput title="Permanent link">&para;</a></h3> <p>To achieve higher throughput the messages are not replicated across brokers and the acknowledgement can be set to only one broker. Expose resiliency to failures.</p> <p>The number of producers and consumers are aligned, and the number of partitions matches the number of consumers. All consumers are in the same consumer group. Measurement has to be done from the producer code. With 12 producers on a 3 brokers cluster and small payload (128 bytes), with 24 consumers the measured throughput is around 2.3 M messages / second.</p> <h3 id=payload-size>Payload size<a class=headerlink href=#payload-size title="Permanent link">&para;</a></h3> <p>From measurement tests done using Kafka producer performance tool, there is a 1/log(s) curve, where below 10k bytes the performances are correct and then slowly degrade from 3000 msg /s (10k bytes msg) to 65 msg/s (515kb msg).</p> <p>To do performance test the <a href=https://github.com/IBM/event-streams-sample-producer>event-streams-sample-producer</a> github provides producer tool in Java, using a group of threads to run in multi cores machine. This project can be dockerized, and deployed in k8s. It uses the Kafka tool named: <code>ProducerPerformance.java</code> in the jar:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=nt>&lt;dependency&gt;</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>  </span><span class=nt>&lt;groupId&gt;</span>org.apache.kafka<span class=nt>&lt;/groupId&gt;</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>  </span><span class=nt>&lt;artifactId&gt;</span>kafka-tools<span class=nt>&lt;/artifactId&gt;</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=nt>&lt;/dependency&gt;</span>
</code></pre></div> <h3 id=parameter-considerations>Parameter considerations<a class=headerlink href=#parameter-considerations title="Permanent link">&para;</a></h3> <p>There are a lot of factors and parameters that needs to be tuned to improve performance at the brokers threading level (<code>num.replica.fetchers, num.io.threads, num.network.threads, log.cleaner.threads</code> ) and the pod resources constraints. See <a href=https://Kafka.apache.org/documentation/#configuration>the configuration documentation</a>.</p> <h3 id=openshift-specifics>Openshift specifics<a class=headerlink href=#openshift-specifics title="Permanent link">&para;</a></h3> <p>When exposing the Kafka broker via Routes, the traffic is encrypted with TLS, so client needs to deal with TLS certificates and encryption. Routes are exposed via DNS and HAProxy router. The router will act as middleman between Kafka clients and brokers, adding latency, and it can become bottleneck. The traffic generated by client needs to be sized and in case of the router needs to be scaled up, and even isolate the routing by adding a separate router for the Kafka routes.</p> <h2 id=disaster-recovery>Disaster Recovery<a class=headerlink href=#disaster-recovery title="Permanent link">&para;</a></h2> <p>With the current implementation it is recommended to have one cluster per data center / availability zone. Consumers and producers are co-located to the brokers cluster. When there are needs to keep some part of the data replicated in both data centers, you need to assess what kind of data can be aggregated, and if Kafka mirroring tool can be used. The tool consumes from a source cluster, from a given topic, and produces to a destination cluster with the same named topic. It keeps the message key for partitioning, so order is preserved.</p> <p><img alt="High availability cross data centers" src=images/ha-dc1.png></p> <p>The above diagram is using Kafka MirrorMaker 2 with a master to slave deployment. Within the data center 2, the brokers are here to manage the topics and events. When there is no consumer running, nothing happen. Consumers and producers can be started when DC1 fails. This is the active/passive model. In fact, we could have consumers within the DC2 processing topics to manage a read-only model, keeping in memory their projection view, as presented in the <a href=../../patterns/cqrs/ >CQRS pattern</a>.</p> <p>The second solution is to use one MirrorMaker 2 in each site, for each topic. This is an active - active topology: consumers and producers are on both sites. But to avoid infinite loop, we need to use naming convention for the topic, or only produce in the cluster of the main topic. Consumers consume from the replicated topic.</p> <p><img alt="High availability cross data centers" src=images/ha-dc2.png></p> <p>When you want to deploy solution that spreads over multiple regions to support global streaming, you need to address the following challenges:</p> <ul> <li>How do you make data available to applications across multiple data centers?</li> <li>How to serve data closer to the geography?</li> <li>How to be compliant on regulations, like GDPR?</li> <li>How to address no duplication of records?</li> </ul> <p><a href=https://www.confluent.io/blog/apache-kafka-2-4-latest-version-updates/ >Kafka 2.4</a> introduces the capability for a consumer to read messages from the closest replica using some rack-id and specific algorithm. This capability will help to extend the cluster to multiple data center and avoid having consumers going over WAN communication.</p> <h2 id=solution-considerations>Solution Considerations<a class=headerlink href=#solution-considerations title="Permanent link">&para;</a></h2> <p>There are a set of design considerations to assess for each <strong>Kafka</strong> solution:</p> <h3 id=topics>Topics<a class=headerlink href=#topics title="Permanent link">&para;</a></h3> <p>Performance is more a function of number of partitions than topics. Expect that each topic has at least one partition. When considering latency you should aim for limiting to hundreds of topic-partition per broker node.</p> <p>What of the most important question is what topics to use?. What is an event type? Should we use one topic to support multiple event types? Let define that an event type is linked to a main business entity like an Order, a ship, a FridgeredContainer. OrderCreated, OrderCancelled, OrderUpdated, OrderClosed are events linked to the states of the Order. The order of those events matter. So the natural approach is to use one topic per data type or schema, specially when using the topic as Event Sourcing where event order is important to build the audit log. You will use a unique partition to support that. The orderID is the partition key and all events related to the order are in the same topic.</p> <p>The important requirement to consider is the sequencing or event order. When event order is very important then use a unique partition, and use the entity unique identifier as key. Ordering is not preserved across partitions.</p> <p>When dealing with entity, independent entities may be in separate topics, when strongly related one may stay together.</p> <p>Other best practices:</p> <ul> <li>When event order is important use the same topic and use the entity unique identifier as partition key.</li> <li>When two entities are related together by containment relationship then they can be in the same topic.</li> <li>Different entities are separated to different topics.</li> <li>It is possible to group topics in coarse grained one when we discover that several consumers are listening to the same topics.</li> <li>Clearly define the partition key as it could be an compound key based on multiple entities.</li> </ul> <p>With <strong>Kafka</strong> stream, state store or KTable, you should separate the changelog topic from the others.</p> <h3 id=producers>Producers<a class=headerlink href=#producers title="Permanent link">&para;</a></h3> <p>When developing a record producer you need to assess the following:</p> <ul> <li>What is the expected throughput to send events? Event size * average throughput combined with the expected latency help to compute buffer size.</li> <li>Can the producer batch events together to send them in batch over one send operation?</li> <li>Is there a risk for loosing communication? Tune the RETRIES_CONFIG and buffer size</li> <li>Assess <em>once to exactly once</em> delivery requirement. Look at idempotent producer.</li> </ul> <p>See <a href=../kafka-producers/ >implementation considerations discussion</a></p> <h3 id=consumers>Consumers<a class=headerlink href=#consumers title="Permanent link">&para;</a></h3> <p>From the consumer point of view a set of items need to be addressed during design phase:</p> <ul> <li>Do you need to group consumers for parallel consumption of events?</li> <li>What is the processing done once the record is processed out of the topic? And how a record is supposed to be consumed?.</li> <li>How to persist consumer committed position? (the last offset that has been stored securely)</li> <li>Assess if offsets need to be persisted outside of Kafka?. From version 0.9 offset management is more efficient, and synchronous or asynchronous operations can be done from the consumer code.</li> <li>Does record time sensitive, and it is possible that consumers fall behind, so when a consumer restarts he can bypass missed records?</li> <li>Do the consumer needs to perform joins, aggregations between multiple partitions?</li> </ul> <p>See <a href=../kafka-consumers/ >implementation consideration discussion</a></p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright © 2022 IBM </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/ibm-cloud-architecture target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://twitter.com/agileitarchitecture target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "content.tooltips", "navigation.instant", "navigation.tabs.sticky", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.1e8ae164.min.js></script> </body> </html>